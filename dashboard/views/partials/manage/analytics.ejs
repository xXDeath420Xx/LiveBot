<%
const stats = serverStats || [];
const latestStats = stats.length > 0 ? stats[stats.length - 1] : { total_members: 0, online_members: 0, message_count: 0 };
const totalMessages = stats.reduce((sum, s) => sum + (s.message_count || 0), 0);
const avgMessages = stats.length > 0 ? Math.round(totalMessages / stats.length) : 0;
const memberGrowth = stats.length >= 2 ? stats[stats.length - 1].total_members - stats[0].total_members : 0;
%>

<div class="page-section">
    <div class="page-section-header">
        <div>
            <div class="page-section-title">
                <i class="fas fa-chart-line"></i>
                <span>Server Analytics</span>
            </div>
            <div class="page-section-subtitle">
                Track your server's growth and activity over time
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-4" style="margin-bottom: var(--spacing-6);">
        <div style="background: var(--color-dark-600); padding: var(--spacing-4); border-radius: var(--radius-md); border: 1px solid var(--color-dark-400);">
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--spacing-1);">Total Members</div>
            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary);"><%= latestStats.total_members || 0 %></div>
            <% if (memberGrowth !== 0) { %>
                <div style="font-size: var(--font-size-xs); margin-top: var(--spacing-1);">
                    <span style="color: <%= memberGrowth > 0 ? 'var(--color-success)' : 'var(--color-danger)' %>;">
                        <i class="fas fa-arrow-<%= memberGrowth > 0 ? 'up' : 'down' %>"></i>
                        <%= Math.abs(memberGrowth) %> (30d)
                    </span>
                </div>
            <% } %>
        </div>
        <div style="background: var(--color-dark-600); padding: var(--spacing-4); border-radius: var(--radius-md); border: 1px solid var(--color-dark-400);">
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--spacing-1);">Online Members</div>
            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-success);"><%= latestStats.online_members || 0 %></div>
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--spacing-1);">
                <%= latestStats.total_members > 0 ? Math.round((latestStats.online_members / latestStats.total_members) * 100) : 0 %>% online
            </div>
        </div>
        <div style="background: var(--color-dark-600); padding: var(--spacing-4); border-radius: var(--radius-md); border: 1px solid var(--color-dark-400);">
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--spacing-1);">Avg Messages/Day</div>
            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary-400);"><%= avgMessages %></div>
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--spacing-1);">
                Last 30 days
            </div>
        </div>
        <div style="background: var(--color-dark-600); padding: var(--spacing-4); border-radius: var(--radius-md); border: 1px solid var(--color-dark-400);">
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--spacing-1);">Total Messages</div>
            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-accent-purple);"><%= totalMessages.toLocaleString() %></div>
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--spacing-1);">
                30 day period
            </div>
        </div>
    </div>

    <!-- Charts -->
    <% if (stats.length > 0) { %>
        <!-- Member Chart -->
        <div style="background: var(--color-dark-600); padding: var(--spacing-6); border-radius: var(--radius-lg); border: 1px solid var(--color-dark-400); margin-bottom: var(--spacing-6);">
            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text-primary); margin: 0 0 var(--spacing-4) 0;">
                <i class="fas fa-users" style="color: var(--color-primary-400);"></i>
                Member Growth
            </h3>
            <div style="position: relative; height: 300px;">
                <canvas id="memberChart"></canvas>
            </div>
        </div>

        <!-- Message Chart -->
        <div style="background: var(--color-dark-600); padding: var(--spacing-6); border-radius: var(--radius-lg); border: 1px solid var(--color-dark-400); margin-bottom: var(--spacing-6);">
            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text-primary); margin: 0 0 var(--spacing-4) 0;">
                <i class="fas fa-comment-dots" style="color: var(--color-primary-400);"></i>
                Message Activity
            </h3>
            <div style="position: relative; height: 300px;">
                <canvas id="messageChart"></canvas>
            </div>
        </div>

        <!-- Voice Activity Chart -->
        <div style="background: var(--color-dark-600); padding: var(--spacing-6); border-radius: var(--radius-lg); border: 1px solid var(--color-dark-400);">
            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text-primary); margin: 0 0 var(--spacing-4) 0;">
                <i class="fas fa-microphone" style="color: var(--color-primary-400);"></i>
                Engagement Overview
            </h3>
            <div style="position: relative; height: 300px;">
                <canvas id="engagementChart"></canvas>
            </div>
        </div>
    <% } else { %>
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="empty-state-title">No Analytics Data</div>
            <div class="empty-state-description">
                Server analytics will appear here once data collection has begun
            </div>
        </div>
    <% } %>
</div>

<% if (stats.length > 0) { %>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const statsData = <%- JSON.stringify(stats) %>;

    const labels = statsData.map(s => {
        const date = new Date(s.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });
    const totalMembers = statsData.map(s => s.total_members || 0);
    const onlineMembers = statsData.map(s => s.online_members || 0);
    const messageCounts = statsData.map(s => s.message_count || 0);

    const chartDefaults = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#B9BBBE',
                    font: { size: 12 }
                }
            }
        },
        scales: {
            x: {
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: '#8E9297' }
            },
            y: {
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: '#8E9297' }
            }
        }
    };

    // Member Chart
    new Chart(document.getElementById('memberChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Members',
                data: totalMembers,
                borderColor: '#5865F2',
                backgroundColor: 'rgba(88, 101, 242, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 5
            }, {
                label: 'Online Members',
                data: onlineMembers,
                borderColor: '#3BA55D',
                backgroundColor: 'rgba(59, 165, 93, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: chartDefaults
    });

    // Message Chart
    new Chart(document.getElementById('messageChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Messages per Day',
                data: messageCounts,
                backgroundColor: 'rgba(255, 170, 0, 0.7)',
                borderColor: '#FFAA00',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: chartDefaults
    });

    // Engagement Chart (Combined)
    new Chart(document.getElementById('engagementChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Messages',
                data: messageCounts,
                borderColor: '#FFAA00',
                backgroundColor: 'rgba(255, 170, 0, 0.1)',
                tension: 0.4,
                fill: true,
                yAxisID: 'y'
            }, {
                label: 'Member Growth',
                data: totalMembers,
                borderColor: '#5865F2',
                backgroundColor: 'rgba(88, 101, 242, 0.1)',
                tension: 0.4,
                fill: true,
                yAxisID: 'y1'
            }]
        },
        options: {
            ...chartDefaults,
            scales: {
                x: chartDefaults.scales.x,
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: '#8E9297' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    ticks: { color: '#8E9297' }
                }
            }
        }
    });
});
</script>
<% } %>

<style>
.empty-state {
    text-align: center;
    padding: var(--spacing-12) var(--spacing-8);
}

.empty-state-icon {
    font-size: 4rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-4);
}

.empty-state-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-2);
}

.empty-state-description {
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-6);
}
</style>