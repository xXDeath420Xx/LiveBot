<div class="content-card">
    <h2><i class="fas fa-paint-brush me-2"></i>Channel Appearance & Behavior</h2>
    <p class="text-muted">Set channel-specific overrides for appearance and announcement behavior. Settings here will override the server defaults.</p>
    <hr class="my-4">
    <form action="/manage/<%= guild.id %>/channel-appearance/save" method="POST" enctype="multipart/form-data">
        <div class="mb-3">
            <label class="form-label">Channel to Customize</label>
            <select name="channelId" id="appearance-channel-select" class="form-select" required>
                <option value="">-- Select a channel --</option>
                <% channels.forEach(channel => { %>
                    <option value="<%= channel.id %>">#<%= channel.name %></option>
                <% }) %>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Custom Nickname</label>
            <input type="text" class="form-control" id="appearance-nickname" name="nickname" placeholder='Optional Nickname (type "reset" to clear)' maxlength="80">
        </div>
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Upload New Avatar</label>
                <input class="form-control" type="file" name="avatar" accept="image/*">
                <div class="form-text">Current: <span id="appearance-current-avatar">None</span></div>
            </div>
            <div class="col-md-6">
                <label class="form-label">Or Use Avatar URL</label>
                <input type="text" class="form-control" id="appearance-avatar-url" name="avatar_url_text" placeholder='Optional URL (type "reset" to clear)'>
            </div>
        </div>
        <hr class="my-4">
        <h4 class="mb-3">Behavior Overrides</h4>
        <div class="row">
             <div class="col-md-6 mb-3">
                <label for="channel_privacy_setting" class="form-label">Content Privacy Preference</label>
                <select name="privacy_setting" id="channel_privacy_setting" class="form-select">
                    <option value="">Use Server Default</option>
                    <option value="public_only">Announce Public Streams Only</option>
                    <option value="all">Announce All Streams</option>
                </select>
                <div class="form-text">Overrides the server-wide privacy setting for this channel.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="channel_summary_persistence" class="form-label">Stream Summary Persistence</label>
                <select name="summary_persistence" id="channel_summary_persistence" class="form-select">
                    <option value="">Use Server Default</option>
                    <option value="delete_on_offline">Delete Announcement When Stream Ends</option>
                    <option value="keep_on_offline">Keep Announcement When Stream Ends</option>
                </select>
                <div class="form-text">Overrides the server-wide summary persistence for this channel.</div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-4"><i class="fas fa-save me-2"></i>Save Channel Settings</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ensure this script runs only once and targets the correct elements
        if (window.appearanceScriptLoaded) return;
        window.appearanceScriptLoaded = true;

        const channelSettings = <%- JSON.stringify(channelSettings || []) %>;
        const settingsMap = new Map(channelSettings.map(s => [s.channel_id, s]));
        
        const channelSelect = document.getElementById('appearance-channel-select');
        if (!channelSelect) return; // Exit if the select element isn't on the page

        const nicknameInput = document.getElementById('appearance-nickname');
        const avatarUrlInput = document.getElementById('appearance-avatar-url');
        const currentAvatarSpan = document.getElementById('appearance-current-avatar');
        const privacySelect = document.getElementById('channel_privacy_setting');
        const persistenceSelect = document.getElementById('channel_summary_persistence');

        channelSelect.addEventListener('change', function() {
            const selectedChannelId = this.value;
            const settings = settingsMap.get(selectedChannelId);

            // Reset fields to default state
            nicknameInput.value = '';
            avatarUrlInput.value = '';
            currentAvatarSpan.innerHTML = 'None';
            privacySelect.value = ''; // Default to "Use Server Default"
            persistenceSelect.value = ''; // Default to "Use Server Default"

            if (settings) {
                nicknameInput.value = settings.nickname || '';
                // We don't set the avatar URL input directly to avoid confusion, but we show the current one.
                if (settings.avatar_url) {
                    currentAvatarSpan.innerHTML = `<a href="${settings.avatar_url}" target="_blank" rel="noopener noreferrer">View Current</a>`;
                } else {
                    currentAvatarSpan.innerHTML = 'None';
                }
                // A NULL in the DB means inherit, which corresponds to an empty string value in the dropdown
                privacySelect.value = settings.privacy_setting || ''; 
                persistenceSelect.value = settings.summary_persistence || '';
            }
        });
    });
</script>