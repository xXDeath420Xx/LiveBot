<div class="page-section">
    <div class="page-section-header">
        <div>
            <div class="page-section-title">
                <i class="fas fa-ticket-alt"></i>
                <span>Ticket System</span>
            </div>
            <div class="page-section-subtitle">
                Set up a support ticket system for your server
            </div>
        </div>
    </div>

    <!-- Configuration Card -->
    <div style="background: var(--color-dark-600); border: 1px solid var(--color-dark-400); border-radius: var(--radius-lg); padding: var(--spacing-6); margin-bottom: var(--spacing-6);">
        <div style="display: flex; align-items: center; gap: var(--spacing-3); margin-bottom: var(--spacing-4);">
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--color-primary-500), var(--color-primary-600)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i class="fas fa-cog" style="color: white; font-size: 1.25rem;"></i>
            </div>
            <div>
                <h4 style="margin: 0; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text-primary);">Ticket Configuration</h4>
                <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-text-muted);">Configure ticket panel, category, and support team</p>
            </div>
        </div>

        <form action="/manage/<%= guild.id %>/update-tickets" method="POST">
            <div class="grid grid-cols-2" style="gap: var(--spacing-4); margin-bottom: var(--spacing-4);">
                <div>
                    <label class="form-label">Ticket Panel Channel</label>
                    <select class="form-select" id="ticketPanelChannel" name="panel_channel_id">
                        <option value="">Select a channel</option>
                        <% channels.forEach(channel => { %>
                            <option value="<%= channel.id %>" <%= ticketConfig && ticketConfig.panel_channel_id === channel.id ? 'selected' : '' %>>#<%= channel.name %></option>
                        <% }) %>
                    </select>
                    <div class="form-help">The bot will post a "Create Ticket" button in this channel</div>
                </div>

                <div>
                    <label class="form-label">Ticket Category</label>
                    <select class="form-select" id="ticketCategory" name="ticket_category_id">
                        <option value="">Select a category</option>
                        <% categories.forEach(category => { %>
                            <option value="<%= category.id %>" <%= ticketConfig && ticketConfig.ticket_category_id === category.id ? 'selected' : '' %>><%= category.name %></option>
                        <% }) %>
                    </select>
                    <div class="form-help">New ticket channels will be created in this category</div>
                </div>
            </div>

            <div style="margin-bottom: var(--spacing-4);">
                <label class="form-label">Support Team Role</label>
                <select class="form-select" id="ticketSupportRole" name="support_role_id">
                    <option value="">Select a role</option>
                    <% roles.forEach(role => { %>
                        <option value="<%= role.id %>" <%= ticketConfig && ticketConfig.support_role_id === role.id ? 'selected' : '' %>><%= role.name %></option>
                    <% }) %>
                </select>
                <div class="form-help">Users with this role will be able to view and manage tickets</div>
            </div>

            <% if (ticketConfig && ticketConfig.panel_channel_id && ticketConfig.ticket_category_id && ticketConfig.support_role_id) { %>
                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: var(--radius-md); padding: var(--spacing-4); margin-bottom: var(--spacing-4);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-2);">
                        <i class="fas fa-check-circle" style="color: var(--color-success);"></i>
                        <span style="font-size: var(--font-size-sm); color: var(--color-text-primary);">Ticket system is fully configured</span>
                    </div>
                </div>
            <% } %>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                <span>Save Ticket Settings</span>
            </button>
        </form>
    </div>

    <!-- Create Panel Card -->
    <div style="background: var(--color-dark-600); border: 1px solid var(--color-dark-400); border-radius: var(--radius-lg); padding: var(--spacing-6);">
        <div style="display: flex; align-items: center; gap: var(--spacing-3); margin-bottom: var(--spacing-4);">
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--color-accent-blue), var(--color-primary-500)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i class="fas fa-paper-plane" style="color: white; font-size: 1.25rem;"></i>
            </div>
            <div style="flex: 1;">
                <h4 style="margin: 0; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text-primary);">Deploy Ticket Panel</h4>
                <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-text-muted);">Post the ticket creation button to the configured channel</p>
            </div>
        </div>

        <% if (ticketConfig && ticketConfig.panel_channel_id && ticketConfig.ticket_category_id) { %>
            <form action="/manage/<%= guild.id %>/create-ticket-panel" method="POST">
                <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: var(--radius-md); padding: var(--spacing-4); margin-bottom: var(--spacing-4);">
                    <div style="display: flex; gap: var(--spacing-3);">
                        <i class="fas fa-info-circle" style="color: var(--color-accent-blue); margin-top: 2px;"></i>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-primary);">
                            <strong>Ready to deploy!</strong><br>
                            <span style="color: var(--color-text-secondary);">
                                Click the button below to post a ticket creation panel to
                                <% const panelChannel = channels.find(c => c.id === ticketConfig.panel_channel_id); %>
                                <strong>#<%= panelChannel ? panelChannel.name : 'Unknown' %></strong>
                            </span>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    <span>Create Ticket Panel</span>
                </button>
            </form>
        <% } else { %>
            <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05)); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: var(--radius-md); padding: var(--spacing-4);">
                <div style="display: flex; gap: var(--spacing-3);">
                    <i class="fas fa-exclamation-triangle" style="color: var(--color-warning); margin-top: 2px;"></i>
                    <div style="font-size: var(--font-size-sm); color: var(--color-text-primary);">
                        <strong>Configuration Required</strong><br>
                        <span style="color: var(--color-text-secondary);">Please configure the ticket panel channel and category above before creating the panel</span>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

    <!-- How It Works -->
    <div style="margin-top: var(--spacing-6); background: linear-gradient(135deg, rgba(88, 101, 242, 0.1), rgba(88, 101, 242, 0.05)); border: 1px solid rgba(88, 101, 242, 0.3); border-radius: var(--radius-lg); padding: var(--spacing-4);">
        <div style="display: flex; gap: var(--spacing-3);">
            <i class="fas fa-lightbulb" style="color: var(--color-primary-400); font-size: 1.25rem; margin-top: 2px;"></i>
            <div>
                <div style="font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: var(--color-text-primary); margin-bottom: var(--spacing-2);">
                    How the ticket system works
                </div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: 1.6;">
                    <strong style="color: var(--color-text-primary);">1.</strong> Users click the "Create Ticket" button in the panel channel<br>
                    <strong style="color: var(--color-text-primary);">2.</strong> Bot creates a private ticket channel in the configured category<br>
                    <strong style="color: var(--color-text-primary);">3.</strong> Only the user and support team can see the ticket<br>
                    <strong style="color: var(--color-text-primary);">4.</strong> Support team can close tickets when resolved
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ticket Analytics -->
<% if (ticketConfig && ticketConfig.panel_channel_id && ticketConfig.ticket_category_id) { %>
<div class="page-section" style="margin-top: var(--spacing-6);">
    <div class="page-section-header">
        <div>
            <div class="page-section-title">
                <i class="fas fa-chart-line"></i>
                <span>Ticket Analytics</span>
            </div>
            <div class="page-section-subtitle">
                View statistics and performance metrics
            </div>
        </div>
    </div>

    <div class="grid grid-cols-4" style="gap: var(--spacing-4); margin-bottom: var(--spacing-6);">
        <div class="ticket-stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.3);">
            <div class="ticket-stat-icon" style="background: linear-gradient(135deg, var(--color-accent-blue), var(--color-primary-500));">
                <i class="fas fa-ticket-alt"></i>
            </div>
            <div class="ticket-stat-content">
                <div class="ticket-stat-value"><%= data.ticketStats ? data.ticketStats.totalTickets : 0 %></div>
                <div class="ticket-stat-label">Total Tickets</div>
            </div>
        </div>

        <div class="ticket-stat-card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 1px solid rgba(34, 197, 94, 0.3);">
            <div class="ticket-stat-icon" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                <i class="fas fa-folder-open"></i>
            </div>
            <div class="ticket-stat-content">
                <div class="ticket-stat-value"><%= data.ticketStats ? data.ticketStats.openTickets : 0 %></div>
                <div class="ticket-stat-label">Open Tickets</div>
            </div>
        </div>

        <div class="ticket-stat-card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(168, 85, 247, 0.05)); border: 1px solid rgba(168, 85, 247, 0.3);">
            <div class="ticket-stat-icon" style="background: linear-gradient(135deg, #a855f7, #9333ea);">
                <i class="fas fa-clock"></i>
            </div>
            <div class="ticket-stat-content">
                <div class="ticket-stat-value"><%= data.ticketStats ? data.ticketStats.avgResponseTime : '0m' %></div>
                <div class="ticket-stat-label">Avg Response</div>
            </div>
        </div>

        <div class="ticket-stat-card" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(236, 72, 153, 0.05)); border: 1px solid rgba(236, 72, 153, 0.3);">
            <div class="ticket-stat-icon" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                <i class="fas fa-check-double"></i>
            </div>
            <div class="ticket-stat-content">
                <div class="ticket-stat-value"><%= data.ticketStats ? data.ticketStats.avgResolutionTime : '0m' %></div>
                <div class="ticket-stat-label">Avg Resolution</div>
            </div>
        </div>
    </div>

    <% if (data.ticketStats && data.ticketStats.staffStats) { %>
    <div style="background: var(--color-dark-600); border: 1px solid var(--color-dark-400); border-radius: var(--radius-lg); padding: var(--spacing-6);">
        <div style="display: flex; align-items: center; gap: var(--spacing-3); margin-bottom: var(--spacing-4);">
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--color-accent-purple), var(--color-primary-600)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i class="fas fa-users" style="color: white; font-size: 1.25rem;"></i>
            </div>
            <div>
                <h4 style="margin: 0; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text-primary);">Support Team Performance</h4>
                <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-text-muted);">Tickets handled by each staff member</p>
            </div>
        </div>

        <div class="ticket-staff-stats">
            <% data.ticketStats.staffStats.forEach(staff => { %>
            <div class="ticket-staff-stat-row">
                <div class="ticket-staff-info">
                    <img src="<%= staff.avatar %>" alt="<%= staff.username %>" class="ticket-staff-avatar">
                    <div>
                        <div class="ticket-staff-name"><%= staff.username %></div>
                        <div class="ticket-staff-tag">@<%= staff.tag %></div>
                    </div>
                </div>
                <div class="ticket-staff-metrics">
                    <div class="ticket-staff-metric">
                        <div class="ticket-staff-metric-value"><%= staff.ticketsHandled %></div>
                        <div class="ticket-staff-metric-label">Handled</div>
                    </div>
                    <div class="ticket-staff-metric">
                        <div class="ticket-staff-metric-value"><%= staff.currentTickets %></div>
                        <div class="ticket-staff-metric-label">Active</div>
                    </div>
                    <div class="ticket-staff-metric">
                        <div class="ticket-staff-metric-value"><%= staff.avgResponseTime %></div>
                        <div class="ticket-staff-metric-label">Avg Response</div>
                    </div>
                </div>
            </div>
            <% }); %>
        </div>
    </div>
    <% } %>
</div>

<!-- Active Tickets Management -->
<div class="page-section" style="margin-top: var(--spacing-6);">
    <div class="page-section-header">
        <div>
            <div class="page-section-title">
                <i class="fas fa-list-ul"></i>
                <span>Active Tickets</span>
            </div>
            <div class="page-section-subtitle">
                Manage all open and active tickets
            </div>
        </div>
    </div>

    <div style="background: var(--color-dark-600); border: 1px solid var(--color-dark-400); border-radius: var(--radius-lg); padding: var(--spacing-6);">
        <!-- Search and Filter -->
        <div style="display: flex; gap: var(--spacing-4); margin-bottom: var(--spacing-4);">
            <div style="flex: 1;">
                <div style="position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 0.875rem;"></i>
                    <input type="text" id="ticketSearchInput" class="form-select" placeholder="Search tickets..." style="padding-left: 36px;">
                </div>
            </div>
            <select id="ticketStatusFilter" class="form-select" style="width: 200px;">
                <option value="">All Statuses</option>
                <option value="open">Open</option>
                <option value="claimed">Claimed</option>
                <option value="pending">Pending</option>
                <option value="resolved">Resolved</option>
            </select>
            <select id="ticketAssigneeFilter" class="form-select" style="width: 200px;">
                <option value="">All Assignees</option>
                <option value="unassigned">Unassigned</option>
                <% if (data.ticketStats && data.ticketStats.staffStats) { %>
                    <% data.ticketStats.staffStats.forEach(staff => { %>
                        <option value="<%= staff.userId %>"><%= staff.username %></option>
                    <% }); %>
                <% } %>
            </select>
        </div>

        <!-- Tickets Table -->
        <div class="ticket-table-wrapper">
            <table class="ticket-table">
                <thead>
                    <tr>
                        <th>Ticket ID</th>
                        <th>User</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Assigned To</th>
                        <th>Created</th>
                        <th>Last Activity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ticketsTableBody">
                    <% if (data.activeTickets && data.activeTickets.length > 0) { %>
                        <% data.activeTickets.forEach(ticket => { %>
                        <tr class="ticket-row" data-ticket-id="<%= ticket.ticket_id %>" data-status="<%= ticket.status %>" data-assignee="<%= ticket.claimed_by || 'unassigned' %>">
                            <td>
                                <div class="ticket-id-cell">
                                    <i class="fas fa-ticket-alt" style="color: var(--color-primary-400); margin-right: 8px;"></i>
                                    <span>#<%= ticket.ticket_id %></span>
                                </div>
                            </td>
                            <td>
                                <div class="ticket-user-cell">
                                    <img src="<%= ticket.user_avatar %>" alt="<%= ticket.user_name %>" class="ticket-user-avatar">
                                    <div>
                                        <div class="ticket-user-name"><%= ticket.user_name %></div>
                                        <div class="ticket-user-tag">@<%= ticket.user_tag %></div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="ticket-subject"><%= ticket.subject || 'Support Request' %></div>
                            </td>
                            <td>
                                <span class="ticket-status-badge ticket-status-<%= ticket.status %>">
                                    <%= ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1) %>
                                </span>
                            </td>
                            <td>
                                <% if (ticket.claimed_by) { %>
                                <div class="ticket-assignee-cell">
                                    <img src="<%= ticket.assignee_avatar %>" alt="<%= ticket.assignee_name %>" class="ticket-assignee-avatar">
                                    <span><%= ticket.assignee_name %></span>
                                </div>
                                <% } else { %>
                                <span style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Unassigned</span>
                                <% } %>
                            </td>
                            <td>
                                <div class="ticket-date">
                                    <div><%= new Date(ticket.created_at).toLocaleDateString() %></div>
                                    <div style="font-size: var(--font-size-xs); color: var(--color-text-muted);"><%= new Date(ticket.created_at).toLocaleTimeString() %></div>
                                </div>
                            </td>
                            <td>
                                <div class="ticket-date">
                                    <div><%= new Date(ticket.last_activity).toLocaleDateString() %></div>
                                    <div style="font-size: var(--font-size-xs); color: var(--color-text-muted);"><%= new Date(ticket.last_activity).toLocaleTimeString() %></div>
                                </div>
                            </td>
                            <td>
                                <div class="ticket-actions">
                                    <button class="ticket-action-btn" onclick="viewTicketDetails('<%= ticket.ticket_id %>')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="ticket-action-btn" onclick="assignTicket('<%= ticket.ticket_id %>')" title="Assign">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                    <button class="ticket-action-btn" onclick="addTicketNote('<%= ticket.ticket_id %>')" title="Add Note">
                                        <i class="fas fa-sticky-note"></i>
                                    </button>
                                    <button class="ticket-action-btn ticket-action-close" onclick="closeTicket('<%= ticket.ticket_id %>')" title="Close Ticket">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="8" style="text-align: center; padding: var(--spacing-8); color: var(--color-text-muted);">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: var(--spacing-4); opacity: 0.5;"></i>
                                <div>No active tickets</div>
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>
<% } %>

<!-- Ticket Details Modal -->
<div id="ticketDetailsModal" class="ticket-modal" style="display: none;">
    <div class="ticket-modal-overlay" onclick="closeTicketDetailsModal()"></div>
    <div class="ticket-modal-content">
        <div class="ticket-modal-header">
            <div>
                <h3 class="ticket-modal-title">
                    <i class="fas fa-ticket-alt"></i>
                    <span id="modalTicketTitle">Ticket Details</span>
                </h3>
                <p class="ticket-modal-subtitle" id="modalTicketSubtitle">Loading...</p>
            </div>
            <button class="ticket-modal-close" onclick="closeTicketDetailsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="ticket-modal-body">
            <div class="ticket-modal-layout">
                <!-- Main Content -->
                <div class="ticket-modal-main">
                    <!-- Messages Section -->
                    <div class="ticket-section">
                        <div class="ticket-section-header">
                            <i class="fas fa-comments"></i>
                            <span>Conversation</span>
                        </div>
                        <div class="ticket-messages" id="ticketMessagesContainer">
                            <!-- Messages will be loaded here -->
                        </div>
                    </div>

                    <!-- Internal Notes Section -->
                    <div class="ticket-section" style="margin-top: var(--spacing-4);">
                        <div class="ticket-section-header">
                            <i class="fas fa-file-alt"></i>
                            <span>Internal Notes</span>
                            <span style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-left: auto;">(Staff Only)</span>
                        </div>
                        <div class="ticket-notes" id="ticketNotesContainer">
                            <!-- Notes will be loaded here -->
                        </div>
                        <div class="ticket-add-note">
                            <textarea id="newNoteTextarea" class="ticket-note-input" placeholder="Add an internal note..."></textarea>
                            <button class="btn btn-primary" onclick="submitTicketNote()" style="margin-top: var(--spacing-2);">
                                <i class="fas fa-plus"></i>
                                <span>Add Note</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="ticket-modal-sidebar">
                    <!-- Actions Card -->
                    <div class="ticket-sidebar-card">
                        <div class="ticket-sidebar-card-header">
                            <i class="fas fa-cog"></i>
                            <span>Actions</span>
                        </div>
                        <div class="ticket-sidebar-actions">
                            <button class="ticket-sidebar-btn" onclick="assignTicketFromModal()">
                                <i class="fas fa-user-plus"></i>
                                <span>Assign Ticket</span>
                            </button>
                            <button class="ticket-sidebar-btn" onclick="transferTicketFromModal()">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Transfer Ticket</span>
                            </button>
                            <button class="ticket-sidebar-btn ticket-sidebar-btn-danger" onclick="closeTicketFromModal()">
                                <i class="fas fa-times-circle"></i>
                                <span>Close Ticket</span>
                            </button>
                        </div>
                    </div>

                    <!-- User Info Card -->
                    <div class="ticket-sidebar-card">
                        <div class="ticket-sidebar-card-header">
                            <i class="fas fa-user"></i>
                            <span>User Information</span>
                        </div>
                        <div class="ticket-user-info" id="ticketUserInfo">
                            <!-- User info will be loaded here -->
                        </div>
                    </div>

                    <!-- Ticket Info Card -->
                    <div class="ticket-sidebar-card">
                        <div class="ticket-sidebar-card-header">
                            <i class="fas fa-info-circle"></i>
                            <span>Ticket Information</span>
                        </div>
                        <div class="ticket-info-details" id="ticketInfoDetails">
                            <!-- Ticket details will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-2);
}

.form-help {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: var(--spacing-2);
}

/* Ticket Analytics Styles */
.ticket-stat-card {
    border-radius: var(--radius-lg);
    padding: var(--spacing-4);
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
}

.ticket-stat-icon {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.ticket-stat-icon i {
    color: white;
    font-size: 1.5rem;
}

.ticket-stat-content {
    flex: 1;
}

.ticket-stat-value {
    font-size: 2rem;
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    line-height: 1;
    margin-bottom: var(--spacing-1);
}

.ticket-stat-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    font-weight: var(--font-weight-medium);
}

/* Staff Stats */
.ticket-staff-stats {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
}

.ticket-staff-stat-row {
    background: var(--color-dark-700);
    border: 1px solid var(--color-dark-500);
    border-radius: var(--radius-md);
    padding: var(--spacing-4);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ticket-staff-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
}

.ticket-staff-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 2px solid var(--color-primary-500);
}

.ticket-staff-name {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
}

.ticket-staff-tag {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
}

.ticket-staff-metrics {
    display: flex;
    gap: var(--spacing-6);
}

.ticket-staff-metric {
    text-align: center;
}

.ticket-staff-metric-value {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
}

.ticket-staff-metric-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: var(--spacing-1);
}

/* Ticket Table Styles */
.ticket-table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-dark-500);
}

.ticket-table {
    width: 100%;
    border-collapse: collapse;
}

.ticket-table thead {
    background: var(--color-dark-700);
    border-bottom: 2px solid var(--color-dark-500);
}

.ticket-table th {
    padding: var(--spacing-3) var(--spacing-4);
    text-align: left;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.ticket-table tbody tr {
    border-bottom: 1px solid var(--color-dark-500);
    transition: background-color 0.2s ease;
}

.ticket-table tbody tr:hover {
    background: var(--color-dark-700);
}

.ticket-table td {
    padding: var(--spacing-4);
    font-size: var(--font-size-sm);
    color: var(--color-text-primary);
}

.ticket-id-cell {
    display: flex;
    align-items: center;
    font-weight: var(--font-weight-semibold);
    color: var(--color-primary-400);
}

.ticket-user-cell {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.ticket-user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.ticket-user-name {
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
}

.ticket-user-tag {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
}

.ticket-subject {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.ticket-status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.ticket-status-open {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
    border: 1px solid rgba(59, 130, 246, 0.5);
}

.ticket-status-claimed {
    background: rgba(168, 85, 247, 0.2);
    color: #c084fc;
    border: 1px solid rgba(168, 85, 247, 0.5);
}

.ticket-status-pending {
    background: rgba(245, 158, 11, 0.2);
    color: #fbbf24;
    border: 1px solid rgba(245, 158, 11, 0.5);
}

.ticket-status-resolved {
    background: rgba(34, 197, 94, 0.2);
    color: #4ade80;
    border: 1px solid rgba(34, 197, 94, 0.5);
}

.ticket-assignee-cell {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.ticket-assignee-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
}

.ticket-date {
    font-size: var(--font-size-sm);
}

.ticket-actions {
    display: flex;
    gap: var(--spacing-2);
}

.ticket-action-btn {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    background: var(--color-dark-700);
    border: 1px solid var(--color-dark-500);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.ticket-action-btn:hover {
    background: var(--color-primary-500);
    border-color: var(--color-primary-500);
    color: white;
}

.ticket-action-btn.ticket-action-close:hover {
    background: #ef4444;
    border-color: #ef4444;
}

/* Modal Styles */
.ticket-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.ticket-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
}

.ticket-modal-content {
    position: relative;
    width: 90%;
    max-width: 1400px;
    max-height: 90vh;
    background: var(--color-dark-600);
    border: 1px solid var(--color-dark-400);
    border-radius: var(--radius-xl);
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.ticket-modal-header {
    padding: var(--spacing-6);
    border-bottom: 1px solid var(--color-dark-500);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ticket-modal-title {
    margin: 0;
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.ticket-modal-title i {
    color: var(--color-primary-400);
}

.ticket-modal-subtitle {
    margin: var(--spacing-1) 0 0 0;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.ticket-modal-close {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    background: var(--color-dark-700);
    border: 1px solid var(--color-dark-500);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.ticket-modal-close:hover {
    background: #ef4444;
    border-color: #ef4444;
    color: white;
}

.ticket-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-6);
}

.ticket-modal-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: var(--spacing-6);
}

.ticket-modal-main {
    min-width: 0;
}

.ticket-section {
    background: var(--color-dark-700);
    border: 1px solid var(--color-dark-500);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.ticket-section-header {
    background: var(--color-dark-600);
    padding: var(--spacing-4);
    border-bottom: 1px solid var(--color-dark-500);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
}

.ticket-messages {
    padding: var(--spacing-4);
    max-height: 400px;
    overflow-y: auto;
}

.ticket-message {
    margin-bottom: var(--spacing-4);
    display: flex;
    gap: var(--spacing-3);
}

.ticket-message:last-child {
    margin-bottom: 0;
}

.ticket-message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0;
}

.ticket-message-content {
    flex: 1;
    background: var(--color-dark-600);
    border: 1px solid var(--color-dark-500);
    border-radius: var(--radius-md);
    padding: var(--spacing-3);
}

.ticket-message-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-2);
}

.ticket-message-author {
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
}

.ticket-message-time {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
}

.ticket-message-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: 1.5;
}

.ticket-notes {
    padding: var(--spacing-4);
    max-height: 300px;
    overflow-y: auto;
}

.ticket-note {
    background: var(--color-dark-600);
    border: 1px solid var(--color-dark-500);
    border-left: 3px solid var(--color-accent-purple);
    border-radius: var(--radius-md);
    padding: var(--spacing-3);
    margin-bottom: var(--spacing-3);
}

.ticket-note:last-child {
    margin-bottom: 0;
}

.ticket-note-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-2);
}

.ticket-note-author {
    font-weight: var(--font-weight-semibold);
    color: var(--color-accent-purple);
    font-size: var(--font-size-sm);
}

.ticket-note-time {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
}

.ticket-note-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: 1.5;
}

.ticket-add-note {
    padding: var(--spacing-4);
    border-top: 1px solid var(--color-dark-500);
}

.ticket-note-input {
    width: 100%;
    min-height: 80px;
    background: var(--color-dark-600);
    border: 1px solid var(--color-dark-500);
    border-radius: var(--radius-md);
    padding: var(--spacing-3);
    font-size: var(--font-size-sm);
    color: var(--color-text-primary);
    resize: vertical;
    font-family: inherit;
}

.ticket-note-input:focus {
    outline: none;
    border-color: var(--color-primary-500);
}

.ticket-modal-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-4);
}

.ticket-sidebar-card {
    background: var(--color-dark-700);
    border: 1px solid var(--color-dark-500);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.ticket-sidebar-card-header {
    background: var(--color-dark-600);
    padding: var(--spacing-3) var(--spacing-4);
    border-bottom: 1px solid var(--color-dark-500);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
}

.ticket-sidebar-actions {
    padding: var(--spacing-3);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
}

.ticket-sidebar-btn {
    width: 100%;
    padding: var(--spacing-3);
    background: var(--color-dark-600);
    border: 1px solid var(--color-dark-500);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.ticket-sidebar-btn:hover {
    background: var(--color-primary-500);
    border-color: var(--color-primary-500);
}

.ticket-sidebar-btn.ticket-sidebar-btn-danger:hover {
    background: #ef4444;
    border-color: #ef4444;
}

.ticket-user-info {
    padding: var(--spacing-4);
}

.ticket-user-info-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    margin-bottom: var(--spacing-4);
}

.ticket-user-info-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 2px solid var(--color-primary-500);
}

.ticket-user-info-name {
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    font-size: var(--font-size-lg);
}

.ticket-user-info-tag {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.ticket-user-info-field {
    margin-bottom: var(--spacing-3);
}

.ticket-user-info-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--spacing-1);
}

.ticket-user-info-value {
    font-size: var(--font-size-sm);
    color: var(--color-text-primary);
    font-weight: var(--font-weight-medium);
}

.ticket-info-details {
    padding: var(--spacing-4);
}

.ticket-info-field {
    margin-bottom: var(--spacing-3);
}

.ticket-info-field:last-child {
    margin-bottom: 0;
}

.ticket-info-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--spacing-1);
}

.ticket-info-value {
    font-size: var(--font-size-sm);
    color: var(--color-text-primary);
    font-weight: var(--font-weight-medium);
}

/* Responsive */
@media (max-width: 1200px) {
    .ticket-modal-layout {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .grid.grid-cols-4 {
        grid-template-columns: 1fr 1fr;
    }

    .ticket-staff-stat-row {
        flex-direction: column;
        gap: var(--spacing-3);
    }

    .ticket-staff-metrics {
        width: 100%;
        justify-content: space-around;
    }
}
</style>

<script>
let currentTicketId = null;

// Search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('ticketSearchInput');
    const statusFilter = document.getElementById('ticketStatusFilter');
    const assigneeFilter = document.getElementById('ticketAssigneeFilter');

    if (searchInput) {
        searchInput.addEventListener('input', filterTickets);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterTickets);
    }
    if (assigneeFilter) {
        assigneeFilter.addEventListener('change', filterTickets);
    }
});

function filterTickets() {
    const searchTerm = document.getElementById('ticketSearchInput')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('ticketStatusFilter')?.value || '';
    const assigneeFilter = document.getElementById('ticketAssigneeFilter')?.value || '';

    const rows = document.querySelectorAll('.ticket-row');

    rows.forEach(row => {
        const ticketId = row.querySelector('.ticket-id-cell span').textContent.toLowerCase();
        const userName = row.querySelector('.ticket-user-name')?.textContent.toLowerCase() || '';
        const subject = row.querySelector('.ticket-subject')?.textContent.toLowerCase() || '';
        const status = row.dataset.status || '';
        const assignee = row.dataset.assignee || '';

        const matchesSearch = ticketId.includes(searchTerm) ||
                            userName.includes(searchTerm) ||
                            subject.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesAssignee = !assigneeFilter || assignee === assigneeFilter;

        if (matchesSearch && matchesStatus && matchesAssignee) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// View ticket details
async function viewTicketDetails(ticketId) {
    currentTicketId = ticketId;
    const modal = document.getElementById('ticketDetailsModal');
    modal.style.display = 'flex';

    try {
        const response = await fetch(`/manage/<%= guild.id %>/ticket/${ticketId}`);
        const data = await response.json();

        // Update modal title
        document.getElementById('modalTicketTitle').textContent = `Ticket #${ticketId}`;
        document.getElementById('modalTicketSubtitle').textContent = data.subject || 'Support Request';

        // Load messages
        const messagesContainer = document.getElementById('ticketMessagesContainer');
        messagesContainer.innerHTML = '';

        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
                messagesContainer.innerHTML += `
                    <div class="ticket-message">
                        <img src="${msg.author_avatar}" alt="${msg.author_name}" class="ticket-message-avatar">
                        <div class="ticket-message-content">
                            <div class="ticket-message-header">
                                <span class="ticket-message-author">${msg.author_name}</span>
                                <span class="ticket-message-time">${new Date(msg.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="ticket-message-text">${escapeHtml(msg.content)}</div>
                        </div>
                    </div>
                `;
            });
        } else {
            messagesContainer.innerHTML = '<div style="text-align: center; padding: var(--spacing-8); color: var(--color-text-muted);">No messages yet</div>';
        }

        // Load notes
        const notesContainer = document.getElementById('ticketNotesContainer');
        notesContainer.innerHTML = '';

        if (data.notes && data.notes.length > 0) {
            data.notes.forEach(note => {
                notesContainer.innerHTML += `
                    <div class="ticket-note">
                        <div class="ticket-note-header">
                            <span class="ticket-note-author">${note.staff_name}</span>
                            <span class="ticket-note-time">${new Date(note.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="ticket-note-text">${escapeHtml(note.note)}</div>
                    </div>
                `;
            });
        } else {
            notesContainer.innerHTML = '<div style="text-align: center; padding: var(--spacing-4); color: var(--color-text-muted); font-size: var(--font-size-sm);">No internal notes</div>';
        }

        // Load user info
        const userInfoContainer = document.getElementById('ticketUserInfo');
        userInfoContainer.innerHTML = `
            <div class="ticket-user-info-row">
                <img src="${data.user.avatar}" alt="${data.user.name}" class="ticket-user-info-avatar">
                <div>
                    <div class="ticket-user-info-name">${data.user.name}</div>
                    <div class="ticket-user-info-tag">@${data.user.tag}</div>
                </div>
            </div>
            <div class="ticket-user-info-field">
                <div class="ticket-user-info-label">User ID</div>
                <div class="ticket-user-info-value">${data.user.id}</div>
            </div>
            <div class="ticket-user-info-field">
                <div class="ticket-user-info-label">Account Created</div>
                <div class="ticket-user-info-value">${new Date(data.user.created_at).toLocaleDateString()}</div>
            </div>
        `;

        // Load ticket info
        const ticketInfoContainer = document.getElementById('ticketInfoDetails');
        ticketInfoContainer.innerHTML = `
            <div class="ticket-info-field">
                <div class="ticket-info-label">Status</div>
                <div class="ticket-info-value">
                    <span class="ticket-status-badge ticket-status-${data.status}">
                        ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}
                    </span>
                </div>
            </div>
            <div class="ticket-info-field">
                <div class="ticket-info-label">Created</div>
                <div class="ticket-info-value">${new Date(data.created_at).toLocaleString()}</div>
            </div>
            <div class="ticket-info-field">
                <div class="ticket-info-label">Last Activity</div>
                <div class="ticket-info-value">${new Date(data.last_activity).toLocaleString()}</div>
            </div>
            <div class="ticket-info-field">
                <div class="ticket-info-label">Assigned To</div>
                <div class="ticket-info-value">${data.assigned_to ? data.assigned_to.name : 'Unassigned'}</div>
            </div>
            <div class="ticket-info-field">
                <div class="ticket-info-label">Channel</div>
                <div class="ticket-info-value">#${data.channel_name || 'Unknown'}</div>
            </div>
        `;

    } catch (error) {
        console.error('Error loading ticket details:', error);
        showNotification('Failed to load ticket details', 'error');
    }
}

function closeTicketDetailsModal() {
    document.getElementById('ticketDetailsModal').style.display = 'none';
    currentTicketId = null;
    document.getElementById('newNoteTextarea').value = '';
}

// Assign ticket
async function assignTicket(ticketId) {
    const staffId = prompt('Enter staff member ID to assign this ticket:');
    if (!staffId) return;

    try {
        const response = await fetch(`/manage/<%= guild.id %>/ticket/${ticketId}/assign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ staff_id: staffId })
        });

        if (response.ok) {
            showNotification('Ticket assigned successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Failed to assign ticket', 'error');
        }
    } catch (error) {
        console.error('Error assigning ticket:', error);
        showNotification('Failed to assign ticket', 'error');
    }
}

function assignTicketFromModal() {
    if (currentTicketId) {
        assignTicket(currentTicketId);
    }
}

// Transfer ticket
async function transferTicketFromModal() {
    if (!currentTicketId) return;

    const staffId = prompt('Enter staff member ID to transfer this ticket:');
    if (!staffId) return;

    try {
        const response = await fetch(`/manage/<%= guild.id %>/ticket/${currentTicketId}/transfer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ staff_id: staffId })
        });

        if (response.ok) {
            showNotification('Ticket transferred successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Failed to transfer ticket', 'error');
        }
    } catch (error) {
        console.error('Error transferring ticket:', error);
        showNotification('Failed to transfer ticket', 'error');
    }
}

// Close ticket
async function closeTicket(ticketId) {
    if (!confirm('Are you sure you want to close this ticket?')) return;

    try {
        const response = await fetch(`/manage/<%= guild.id %>/ticket/${ticketId}/close`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            showNotification('Ticket closed successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Failed to close ticket', 'error');
        }
    } catch (error) {
        console.error('Error closing ticket:', error);
        showNotification('Failed to close ticket', 'error');
    }
}

function closeTicketFromModal() {
    if (currentTicketId) {
        closeTicket(currentTicketId);
    }
}

// Add ticket note
async function addTicketNote(ticketId) {
    const note = prompt('Enter internal note:');
    if (!note) return;

    try {
        const response = await fetch(`/manage/<%= guild.id %>/ticket/${ticketId}/note`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ note })
        });

        if (response.ok) {
            showNotification('Note added successfully', 'success');
        } else {
            showNotification('Failed to add note', 'error');
        }
    } catch (error) {
        console.error('Error adding note:', error);
        showNotification('Failed to add note', 'error');
    }
}

async function submitTicketNote() {
    if (!currentTicketId) return;

    const textarea = document.getElementById('newNoteTextarea');
    const note = textarea.value.trim();

    if (!note) {
        showNotification('Please enter a note', 'error');
        return;
    }

    try {
        const response = await fetch(`/manage/<%= guild.id %>/ticket/${currentTicketId}/note`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ note })
        });

        if (response.ok) {
            showNotification('Note added successfully', 'success');
            textarea.value = '';
            // Reload ticket details
            viewTicketDetails(currentTicketId);
        } else {
            showNotification('Failed to add note', 'error');
        }
    } catch (error) {
        console.error('Error adding note:', error);
        showNotification('Failed to add note', 'error');
    }
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? 'rgba(34, 197, 94, 0.9)' : 'rgba(239, 68, 68, 0.9)'};
        color: white;
        border-radius: 8px;
        font-weight: 500;
        z-index: 10000;
        animation: slideInRight 0.3s ease;
    `;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeTicketDetailsModal();
    }
});
</script>