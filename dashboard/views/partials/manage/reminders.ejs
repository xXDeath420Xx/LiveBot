<div class="plugin-card mt-4">
    <div class="plugin-card-header">
        <h4><i class="fas fa-bell me-2"></i> Server Reminders</h4>
    </div>
    <div class="plugin-card-body">
        <p class="text-muted">Manage reminders set by users in this server. Only channel reminders are shown here.</p>

        <h5>Create New Channel Reminder</h5>
        <form action="/manage/<%= guild.id %>/create-reminder" method="POST">
            <div class="mb-3">
                <label for="reminder-message" class="form-label">Reminder Message</label>
                <input type="text" class="form-control" name="message" id="reminder-message" placeholder="e.g., Don't forget the meeting!" required>
            </div>
            <div class="mb-3">
                <label for="reminder-when" class="form-label">When to Remind (e.g., 10m, 2h, 1d)</label>
                <input type="text" class="form-control" name="when" id="reminder-when" placeholder="e.g., 30m, 1h, 2d" required>
            </div>
            <div class="mb-3">
                <label for="reminder-channel" class="form-label">Target Channel</label>
                <select class="form-select" name="channel_id" id="reminder-channel" required>
                    <% channels.filter(c => c.type === 0 || c.type === 5).forEach(channel => { %>
                        <option value="<%= channel.id %>">#<%= channel.name %></option>
                    <% }); %>
                </select>
                <div class="form-text">The channel where the reminder will be posted.</div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-success"><i class="fas fa-plus me-2"></i> Create Reminder</button>
            </div>
        </form>

        <hr class="my-4">

        <h5>Active Channel Reminders</h5>
        <% const activeReminders = reminders.filter(r => r.is_active && !r.is_dm); %>
        <% if (activeReminders && activeReminders.length > 0) { %>
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Message</th>
                        <th>Remind At</th>
                        <th>Channel</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% activeReminders.forEach(reminder => { %>
                        <tr>
                            <td><%= reminder.id %></td>
                            <td><%= reminder.message %></td>
                            <td><t:<%= Math.floor(new Date(reminder.remind_at).getTime() / 1000) %>:R></td>
                            <td>#<%= channels.find(c => c.id === reminder.channel_id)?.name || 'Unknown' %></td>
                            <td>
                                <form action="/manage/<%= guild.id %>/delete-reminder" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this reminder?')">
                                    <input type="hidden" name="reminderId" value="<%= reminder.id %>">
                                    <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> Delete</button>
                                </form>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <p class="text-muted">No active channel reminders found for this server.</p>
        <% } %>
    </div>
</div>

<script>
    // Function to parse time strings (e.g., "10m", "2h", "1d")
    function parseTimeInput(timeStr) {
        const match = timeStr.match(/^(\d+)(s|m|h|d)$/);
        if (!match) return null;

        const value = parseInt(match[1]);
        const unit = match[2];
        let seconds = 0;

        switch (unit) {
            case 's': seconds = value; break;
            case 'm': seconds = value * 60; break;
            case 'h': seconds = value * 60 * 60; break;
            case 'd': seconds = value * 24 * 60 * 60; break;
        }
        return new Date(Date.now() + seconds * 1000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const reminderForm = document.querySelector('form[action*="/create-reminder"]');
        if (reminderForm) {
            reminderForm.addEventListener('submit', function(event) {
                const whenInput = reminderForm.querySelector('#reminder-when');
                const remindAt = parseTimeInput(whenInput.value);
                if (!remindAt) {
                    alert('Invalid time format. Please use formats like 30m, 2h, 1d.');
                    event.preventDefault();
                }
            });
        }
    });
</script>
