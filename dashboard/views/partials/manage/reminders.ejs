<%
const activeReminders = (reminders || []).filter(r => r.is_active && !r.is_dm);
const completedReminders = (reminders || []).filter(r => !r.is_active);
%>

<div class="page-section">
    <div class="page-section-header">
        <div>
            <div class="page-section-title">
                <i class="fas fa-bell"></i>
                <span>Server Reminders</span>
            </div>
            <div class="page-section-subtitle">
                Manage channel reminders for your server. Personal DM reminders are managed by users individually.
            </div>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-reminder-modal">
            <i class="fas fa-plus"></i>
            <span>Create Reminder</span>
        </button>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-4" style="margin-bottom: var(--spacing-6);">
        <div style="background: var(--color-dark-600); padding: var(--spacing-4); border-radius: var(--radius-md); border: 1px solid var(--color-dark-400);">
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--spacing-1);">Active Reminders</div>
            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary);"><%= activeReminders.length %></div>
        </div>
        <div style="background: var(--color-dark-600); padding: var(--spacing-4); border-radius: var(--radius-md); border: 1px solid var(--color-dark-400);">
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--spacing-1);">Completed</div>
            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-success);"><%= completedReminders.length %></div>
        </div>
        <div style="background: var(--color-dark-600); padding: var(--spacing-4); border-radius: var(--radius-md); border: 1px solid var(--color-dark-400);">
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--spacing-1);">Due Today</div>
            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-warning);"><%= activeReminders.filter(r => {
                const now = new Date();
                const reminderDate = new Date(r.remind_at);
                return reminderDate.getFullYear() === now.getFullYear() &&
                       reminderDate.getMonth() === now.getMonth() &&
                       reminderDate.getDate() === now.getDate();
            }).length %></div>
        </div>
        <div style="background: var(--color-dark-600); padding: var(--spacing-4); border-radius: var(--radius-md); border: 1px solid var(--color-dark-400);">
            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--spacing-1);">Upcoming Week</div>
            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary-400);"><%= activeReminders.filter(r => {
                const now = new Date();
                const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                const reminderDate = new Date(r.remind_at);
                return reminderDate <= weekFromNow && reminderDate >= now;
            }).length %></div>
        </div>
    </div>

    <!-- Active Reminders Table -->
    <% if (activeReminders.length > 0) { %>
        <div style="margin-bottom: var(--spacing-6);">
            <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--color-text-primary); margin-bottom: var(--spacing-4);">
                <i class="fas fa-clock" style="color: var(--color-primary-400); margin-right: var(--spacing-2);"></i>
                Active Reminders
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Message</th>
                            <th>Remind At</th>
                            <th>Channel</th>
                            <th>Created By</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% activeReminders.forEach(reminder => {
                            const reminderTimestamp = Math.floor(new Date(reminder.remind_at).getTime() / 1000);
                        %>
                            <tr>
                                <td>
                                    <div style="font-weight: var(--font-weight-medium); color: var(--color-text-primary); max-width: 400px; overflow: hidden; text-overflow: ellipsis;">
                                        <%= reminder.message %>
                                    </div>
                                </td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: var(--spacing-2);">
                                        <i class="fas fa-calendar" style="color: var(--color-text-muted);"></i>
                                        <span style="color: var(--color-text-secondary);">
                                            <t:<%= reminderTimestamp %>:F>
                                        </span>
                                    </div>
                                    <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--spacing-1);">
                                        <t:<%= reminderTimestamp %>:R>
                                    </div>
                                </td>
                                <td>
                                    <%
                                    const channel = channels.find(c => c.id === reminder.channel_id);
                                    if (channel) {
                                    %>
                                        <span style="color: var(--color-text-secondary);">
                                            <i class="fas fa-hashtag" style="margin-right: var(--spacing-1);"></i>
                                            <%= channel.name %>
                                        </span>
                                    <% } else { %>
                                        <span class="badge badge-danger">Channel Deleted</span>
                                    <% } %>
                                </td>
                                <td>
                                    <span style="color: var(--color-text-muted); font-size: var(--font-size-sm);">
                                        ID: <%= reminder.user_id.substring(0, 8) %>...
                                    </span>
                                </td>
                                <td class="text-end">
                                    <form action="/manage/<%= guild.id %>/delete-reminder" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this reminder?')">
                                        <input type="hidden" name="reminderId" value="<%= reminder.id %>">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i>
                                            <span>Delete</span>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    <% } else { %>
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-bell-slash"></i>
            </div>
            <div class="empty-state-title">No Active Reminders</div>
            <div class="empty-state-description">
                Create a channel reminder to notify your server members at a specific time
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-reminder-modal">
                <i class="fas fa-plus"></i>
                <span>Create First Reminder</span>
            </button>
        </div>
    <% } %>
</div>

<!-- Add Reminder Modal -->
<div class="modal fade" id="add-reminder-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--color-dark-700); border: 1px solid var(--color-dark-400);">
            <div class="modal-header" style="border-bottom: 1px solid var(--color-dark-400);">
                <h5 class="modal-title">
                    <i class="fas fa-bell" style="color: var(--color-primary-400); margin-right: var(--spacing-2);"></i>
                    Create Channel Reminder
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/manage/<%= guild.id %>/create-reminder" method="POST" id="reminder-form">
                <div class="modal-body">
                    <div style="margin-bottom: var(--spacing-4);">
                        <label class="form-label">Reminder Message</label>
                        <textarea class="form-control" name="message" rows="3" placeholder="Don't forget about the team meeting!" required></textarea>
                        <div class="form-help">What should the reminder say?</div>
                    </div>

                    <div style="margin-bottom: var(--spacing-4);">
                        <label class="form-label">When to Remind</label>
                        <input type="text" class="form-control" name="when" id="reminder-when" placeholder="e.g., 30m, 2h, 1d, 1w" required>
                        <div class="form-help">
                            Use format: <code>30m</code> (minutes), <code>2h</code> (hours), <code>1d</code> (days), <code>1w</code> (weeks)
                        </div>
                    </div>

                    <div style="margin-bottom: var(--spacing-4);">
                        <label class="form-label">Target Channel</label>
                        <select class="form-select" name="channel_id" required>
                            <option value="">Select a channel...</option>
                            <% channels.filter(c => c.type === 0 || c.type === 5).forEach(channel => { %>
                                <option value="<%= channel.id %>">#<%= channel.name %></option>
                            <% }); %>
                        </select>
                        <div class="form-help">The channel where the reminder will be posted</div>
                    </div>

                    <div style="padding: var(--spacing-3); background: var(--color-dark-600); border-radius: var(--radius-md); border: 1px solid var(--color-dark-400);">
                        <div style="font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); color: var(--color-text-muted); margin-bottom: var(--spacing-2);">
                            <i class="fas fa-info-circle"></i> Preview
                        </div>
                        <div id="reminder-preview" style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                            Enter a time to see when the reminder will trigger
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--color-dark-400);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-bell"></i>
                        <span>Create Reminder</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.table-container {
    overflow-x: auto;
    border: 1px solid var(--color-dark-400);
    border-radius: var(--radius-lg);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: var(--color-dark-600);
    border-bottom: 2px solid var(--color-dark-400);
}

.data-table th {
    padding: var(--spacing-4);
    text-align: left;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.data-table td {
    padding: var(--spacing-4);
    border-bottom: 1px solid var(--color-dark-400);
}

.data-table tbody tr {
    transition: background var(--transition-base);
}

.data-table tbody tr:hover {
    background: var(--color-dark-600);
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.empty-state {
    text-align: center;
    padding: var(--spacing-12) var(--spacing-8);
}

.empty-state-icon {
    font-size: 4rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-4);
}

.empty-state-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-2);
}

.empty-state-description {
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-6);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const whenInput = document.getElementById('reminder-when');
    const preview = document.getElementById('reminder-preview');

    // Parse time strings (e.g., "10m", "2h", "1d", "1w")
    function parseTimeInput(timeStr) {
        const match = timeStr.match(/^(\d+)(s|m|h|d|w)$/);
        if (!match) return null;

        const value = parseInt(match[1]);
        const unit = match[2];
        let seconds = 0;

        switch (unit) {
            case 's': seconds = value; break;
            case 'm': seconds = value * 60; break;
            case 'h': seconds = value * 60 * 60; break;
            case 'd': seconds = value * 24 * 60 * 60; break;
            case 'w': seconds = value * 7 * 24 * 60 * 60; break;
        }
        return new Date(Date.now() + seconds * 1000);
    }

    if (whenInput && preview) {
        whenInput.addEventListener('input', (e) => {
            const remindAt = parseTimeInput(e.target.value);
            if (remindAt) {
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                preview.innerHTML = `<i class="fas fa-check-circle" style="color: var(--color-success);"></i> Reminder will trigger on <strong>${remindAt.toLocaleDateString('en-US', options)}</strong>`;
            } else if (e.target.value) {
                preview.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--color-danger);"></i> Invalid format. Use: 30m, 2h, 1d, 1w`;
            } else {
                preview.textContent = 'Enter a time to see when the reminder will trigger';
            }
        });
    }

    const reminderForm = document.getElementById('reminder-form');
    if (reminderForm) {
        reminderForm.addEventListener('submit', function(event) {
            const whenInput = reminderForm.querySelector('#reminder-when');
            const remindAt = parseTimeInput(whenInput.value);
            if (!remindAt) {
                alert('Invalid time format. Please use formats like 30m, 2h, 1d, 1w.');
                event.preventDefault();
                return false;
            }

            // Add hidden input with calculated timestamp
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'remind_at';
            hiddenInput.value = remindAt.toISOString();
            reminderForm.appendChild(hiddenInput);
        });
    }
});
</script>
