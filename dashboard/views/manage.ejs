<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage <%= guild.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/dashboard-style.css?v=2.0.0">
</head>
<body class="manage-page">
<%- include('partials/header') %>
<div class="manage-container">
    <aside class="manage-sidebar">
        <div class="sidebar-card text-center">
            <% if (guild.icon) { %><img src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png?size=128" alt="<%= guild.name %> Icon" style="width:90px; height: 90px; border-radius:50%"><% } else { %><div class="d-flex justify-content-center align-items-center" style="width:90px; height:90px; border-radius:50%; background-color: var(--background-tertiary);"><h2 class="m-0"><%= guild.name.charAt(0) %></h2></div><% } %>
            <h4 class="mt-2 mb-1"><%= guild.name %></h4>
            <a href="/dashboard" class="btn btn-sm btn-secondary mt-2">Change Server</a>
        </div>
        <div class="sidebar-card">
            <h5><i class="fas fa-signal me-2"></i>Live Status</h5>
            <div id="live-status-container" class="live-status-scroll mb-2"><p class="text-center small">Loading...</p></div>
        </div>
        <div class="sidebar-card flex-grow-1">
            <h5><i class="fas fa-toolbox me-2"></i>Toolbox</h5>
            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <button class="nav-link text-start active" id="v-pills-streamers-tab" data-bs-toggle="pill" data-bs-target="#streamers-tab" type="button" role="tab">Streamer List</button>
                <button class="nav-link text-start" id="v-pills-core-tab" data-bs-toggle="pill" data-bs-target="#core-tab" type="button" role="tab">Core Settings</button>
                <button class="nav-link text-start" id="v-pills-appearance-tab" data-bs-toggle="pill" data-bs-target="#appearance-tab" type="button" role="tab">Appearance</button>
                <button class="nav-link text-start" id="v-pills-teams-tab" data-bs-toggle="pill" data-bs-target="#teams-tab" type="button" role="tab">Twitch Teams</button>
                <button class="nav-link text-start" id="v-pills-csv-tab" data-bs-toggle="pill" data-bs-target="#csv-tab" type="button" role="tab">Mass Management</button>
            </div>
        </div>
    </aside>
    <main class="manage-main-content">
        <div class="tab-content" id="v-pills-tabContent">
            <div class="tab-pane fade" id="core-tab" role="tabpanel"><%- include('partials/manage/core', {guild, settings, channels, roles}) %></div>
            <div class="tab-pane fade" id="appearance-tab" role="tabpanel"><%- include('partials/manage/appearance', {guild, channels}) %></div>
            <div class="tab-pane fade" id="teams-tab" role="tabpanel"><%- include('partials/manage/teams', {guild, channels, teamSubscriptions, roles}) %></div>
            <div class="tab-pane fade" id="csv-tab" role="tabpanel"><%- include('partials/manage/mass', {guild, channels}) %></div>
            <div class="tab-pane fade show active" id="streamers-tab" role="tabpanel">
                <%- include('partials/manage/add-streamer', {guild, channels}) %>
                <div class="content-card mt-4">
                    <h2><i class="fas fa-stream me-2"></i>Tracked Streamers (<%= totalSubscriptions %>)</h2>
                    <div class="accordion" id="channelsAccordion">
                        <% Object.entries(channelsData).forEach(([channelId, data], index) => {
                            const totalMembers = data.individualStreamers.length + data.teams.reduce((s,t)=>s+t.members.length,0);
                            if (totalMembers === 0) return; // Skip if no streamers or team members
                        %>
                            <div class="accordion-item mb-2">
                                <h2 class="accordion-header"><button class="accordion-button <%= index > 0 ? 'collapsed' : '' %>" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= channelId %>"><%= data.name %><span class="badge bg-secondary ms-auto me-2"><%= totalMembers %> total</span></button></h2>
                                <div id="collapse-<%= channelId %>" class="accordion-collapse collapse <%= index === 0 ? 'show' : '' %>" data-bs-parent="#channelsAccordion">
                                    <div class="accordion-body">
                                        <% if(data.teams.length>0) { %><h6 class="text-uppercase small text-muted mb-2">Synced Teams</h6><% data.teams.forEach(team=>{ %> 
                                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                                <div>
                                                    <strong><%=team.team_name%></strong> (<%=team.members.length%> members)
                                                </div>
                                                <div>
                                                    <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#teamSettingsModal" 
                                                        data-team-id="<%= team.id %>" 
                                                        data-team-name="<%= team.team_name %>" 
                                                        data-channel-id="<%= team.announcement_channel_id || '' %>"
                                                        data-live-role-id="<%= team.live_role_id || '' %>"
                                                        data-webhook-name="<%= team.webhook_name || '' %>"
                                                        data-webhook-avatar-url="<%= team.webhook_avatar_url || '' %>">
                                                        <i class="fas fa-cog"></i>
                                                    </button>
                                                    <form action="/manage/<%= guild.id %>/removeteam" method="POST" class="d-inline" onsubmit="return confirm('Remove team <%= team.team_name %>?')">
                                                        <input type="hidden" name="teamSubscriptionId" value="<%= team.id %>">
                                                        <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-times"></i></button>
                                                    </form>
                                                </div>
                                            </div>
                                            <% team.members.forEach(userGroup => { %>
                                                <div class="list-group-item d-flex flex-column align-items-start ps-4 py-1">
                                                    <div class="d-flex justify-content-between align-items-center w-100">
                                                        <div class="d-flex align-items-center">
                                                            <img src="<%= userGroup.primaryAvatarUrl || '/images/default-icon.png' %>" alt="<%= userGroup.primaryDisplayName %>" style="width:24px; height:24px; border-radius:50%;" class="me-2">
                                                            <strong class="me-2"><%= userGroup.primaryDisplayName %></strong>
                                                            <% if (userGroup.discord_user_id) { %><span class="badge bg-info ms-2">Discord: <%= userGroup.discord_user_id %></span><% } %>
                                                            <% if (userGroup.linkedPlatforms && userGroup.linkedPlatforms.length > 0) { %>
                                                                <% 
                                                                    const linkedPlatformsText = userGroup.linkedPlatforms.map(p => {
                                                                        return `${p.platform}: ${p.username}`;
                                                                    }).join(', ');
                                                                %>
                                                                <span class="badge bg-secondary ms-2"><%= linkedPlatformsText %></span>
                                                            <% } %>
                                                        </div>
                                                        <div>
                                                            <% userGroup.subscriptions.forEach(sub => {
                                                                let platformIconClass = '';
                                                                if (sub.platform === 'twitch') platformIconClass = 'fab fa-twitch';
                                                                else if (sub.platform === 'kick') platformIconClass = 'fab fa-kickstarter';
                                                                else if (sub.platform === 'youtube') platformIconClass = 'fab fa-youtube';
                                                                else if (sub.platform === 'tiktok') platformIconClass = 'fab fa-tiktok';
                                                                else if (sub.platform === 'trovo') platformIconClass = 'fas fa-gamepad';
                                                                else platformIconClass = 'fas fa-globe';
                                                            %>
                                                                <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#streamerSettingsModal" 
                                                                    data-subscription-id="<%= sub.subscription_id %>" 
                                                                    data-streamer-name="<%= sub.username %>" 
                                                                    data-discord-user-id="<%= sub.discord_user_id || '' %>" 
                                                                    data-kick-username="<%= sub.kick_username || '' %>" 
                                                                    data-channel-override="<%= sub.announcement_channel_id || '' %>" 
                                                                    data-override-nickname="<%= sub.override_nickname || '' %>" 
                                                                    data-custom-message="<%= sub.custom_message || '' %>" 
                                                                    data-override-avatar-url="<%= sub.override_avatar_url || '' %>">
                                                                    <i class="<%= platformIconClass %>"></i>
                                                                </button>
                                                                <form action="/manage/<%= guild.id %>/remove-subscription" method="POST" class="d-inline" onsubmit="return confirm('Remove <%= sub.username %> on <%= sub.platform %>?')">
                                                                    <input type="hidden" name="subscription_id" value="<%= sub.subscription_id %>">
                                                                    <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-times"></i></button>
                                                                </form>
                                                            <% }); %>
                                                        </div>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        <% }); %><% } %>

                                        <% if(data.individualStreamers.length>0) { %><h6 class="text-uppercase small text-muted mt-3 mb-2">Individual Streamers</h6><% data.individualStreamers.forEach(userGroup=>{ %>
                                        <div class="list-group-item d-flex flex-column align-items-start px-0 py-2">
                                            <div class="d-flex justify-content-between align-items-center w-100">
                                                <div class="d-flex align-items-center">
                                                    <img src="<%= userGroup.primaryAvatarUrl || '/images/default-icon.png' %>" alt="<%= userGroup.primaryDisplayName %>" style="width:32px; height:32px; border-radius:50%;" class="me-2">
                                                    <strong class="me-2"><%= userGroup.primaryDisplayName %></strong>
                                                    <% if (userGroup.discord_user_id) { %><span class="badge bg-info ms-2">Discord: <%= userGroup.discord_user_id %></span><% } %>
                                                    <% if (userGroup.linkedPlatforms && userGroup.linkedPlatforms.length > 0) { %>
                                                        <% 
                                                            const linkedPlatformsText = userGroup.linkedPlatforms.map(p => {
                                                                return `${p.platform}: ${p.username}`;
                                                            }).join(', ');
                                                        %>
                                                        <span class="badge bg-secondary ms-2"><%= linkedPlatformsText %></span>
                                                    <% } %>
                                                </div>
                                                <div>
                                                    <% userGroup.subscriptions.forEach(sub => {
                                                        // Determine the correct platform icon based on the individual subscription's platform
                                                        let platformIconClass = '';
                                                        if (sub.platform === 'twitch') platformIconClass = 'fab fa-twitch';
                                                        else if (sub.platform === 'kick') platformIconClass = 'fab fa-kickstarter'; // Assuming a Kick icon class exists
                                                        else if (sub.platform === 'youtube') platformIconClass = 'fab fa-youtube';
                                                        else if (sub.platform === 'tiktok') platformIconClass = 'fab fa-tiktok';
                                                        else if (sub.platform === 'trovo') platformIconClass = 'fas fa-gamepad'; // Generic icon for Trovo if no specific one
                                                        else platformIconClass = 'fas fa-globe'; // Default icon
                                                    %>
                                                        <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#streamerSettingsModal" 
                                                            data-subscription-id="<%= sub.subscription_id %>" 
                                                            data-streamer-name="<%= sub.username %>" 
                                                            data-discord-user-id="<%= sub.discord_user_id || '' %>" 
                                                            data-kick-username="<%= sub.kick_username || '' %>" 
                                                            data-channel-override="<%= sub.announcement_channel_id || '' %>" 
                                                            data-override-nickname="<%= sub.override_nickname || '' %>" 
                                                            data-custom-message="<%= sub.custom_message || '' %>" 
                                                            data-override-avatar-url="<%= sub.override_avatar_url || '' %>">
                                                            <i class="<%= platformIconClass %>"></i>
                                                        </button>
                                                        <form action="/manage/<%= guild.id %>/remove-subscription" method="POST" class="d-inline" onsubmit="return confirm('Remove <%= sub.username %> on <%= sub.platform %>?')">
                                                            <input type="hidden" name="subscription_id" value="<%= sub.subscription_id %>">
                                                            <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-times"></i></button>
                                                        </form>
                                                    <% }); %>
                                                </div>
                                            </div>
                                            <% if (userGroup.subscriptions.length > 1) { %>
                                                <div class="w-100 mt-2 ps-4 small text-muted">Multiple subscriptions for this user.</div>
                                            <% } %>
                                        </div>
                                        <% }) %><% } %>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<%- include('partials/manage-modal', { guild, channels }) %>
<%- include('partials/manage-team-modal', { guild, channels, roles }) %>
<%- include('partials/footer') %>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab persistence
        const lastTab = localStorage.getItem('lastTab-' + '<%= guild.id %>');
        if (lastTab) {
            document.querySelector(lastTab).click();
        }
        document.querySelectorAll('.nav-pills .nav-link').forEach(tab => {
            tab.addEventListener('shown.bs.tab', e => {
                localStorage.setItem('lastTab-' + '<%= guild.id %>', '#' + e.target.id);
            });
        });

        // Live status fetcher
        async function fetchGuildLiveStatus() {
            try {
                const response = await fetch(`/api/guilds/<%= guild.id %>/livestatus`);
                const data = await response.json();
                const container = document.getElementById("live-status-container");
                container.innerHTML = data.length > 0 ? data.map(s => {
                    let platformsInfo = [];
                    if (Array.isArray(s.live_platforms)) {
                        const uniqueGames = new Set(s.live_platforms.map(p => p.game));
                        if (uniqueGames.size === 1) {
                            // All platforms playing the same game
                            const commonGame = uniqueGames.values().next().value;
                            const platformNames = s.live_platforms.map(p => 
                                `<a href="${p.url}" target="_blank" class="text-decoration-none text-white" title="${p.platform}">${p.platform}</a>`
                            ).join(', ');
                            platformsInfo.push(`${platformNames}: ${commonGame}`);
                        } else {
                            // Platforms playing different games
                            s.live_platforms.forEach(p => {
                                platformsInfo.push(
                                    `<a href="${p.url}" target="_blank" class="text-decoration-none text-white" title="${p.platform}">${p.platform}: ${p.game}</a>`
                                );
                            });
                        }
                    }
                    const platformsText = platformsInfo.join(' | ');

                    return `<div class="live-streamer-card"><img src="${s.avatar_url}" class="live-avatar"> <div class="live-info"><strong>${s.username}</strong><span class="badge bg-secondary live-platforms-pill">${platformsText}</span></div></div>`
                }).join('') : '<p class="text-center small text-muted">No one is live.</p>';
            } catch (error) {
                document.getElementById("live-status-container").innerHTML = '<p class="text-danger text-center small">Failed to load status.</p>';
            }
        }
        fetchGuildLiveStatus();
        setInterval(fetchGuildLiveStatus, 60000);

        // Streamer Settings Modal data population
        const streamerSettingsModal = document.getElementById("streamerSettingsModal");
        streamerSettingsModal.addEventListener("show.bs.modal", event => {
            const btn = event.relatedTarget;
            streamerSettingsModal.querySelector("#modal-streamer-name").textContent = btn.dataset.streamerName;
            Object.keys(btn.dataset).forEach(key => {
                const input = streamerSettingsModal.querySelector(`#edit-${key.replace(/([A-Z])/g, "-$1").toLowerCase()}`);
                if(input) input.value = btn.dataset[key];
            });
            streamerSettingsModal.querySelector("#edit-channel-override").value = btn.dataset.channelOverride || ""; // Handle empty value for default
        });

        // Team Settings Modal data population
        const teamSettingsModal = document.getElementById("teamSettingsModal");
        if (teamSettingsModal) {
            teamSettingsModal.addEventListener("show.bs.modal", event => {
                const btn = event.relatedTarget;
                teamSettingsModal.querySelector("#modal-team-name").textContent = btn.dataset.teamName;
                teamSettingsModal.querySelector("#edit-team-subscription-id").value = btn.dataset.teamId;
                teamSettingsModal.querySelector("#edit-team-channel-id").value = btn.dataset.channelId || "";
                teamSettingsModal.querySelector("#edit-team-live-role-id").value = btn.dataset.liveRoleId || "";
                teamSettingsModal.querySelector("#edit-team-webhook-name").value = btn.dataset.webhookName || "";
                teamSettingsModal.querySelector("#edit-team-webhook-avatar-url").value = btn.dataset.webhookAvatarUrl || "";
            });
        }
    });
</script>
</body>
</html>