<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage <%= guild.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/dashboard-style.css?v=14.2.0">
</head>
<body class="manage-page">
<%- include('partials/header') %>
<div class="manage-container">
    <aside class="manage-sidebar">
        <div class="sidebar-card text-center">
            <a href="https://discordlookup.com/guild/<%= guild.id %>" target="_blank" rel="noopener noreferrer">
                <% if (guild.icon) { %><img src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png?size=128" alt="<%= guild.name %> Icon" class="rounded-circle mb-3"><% } else { %><img src="/images/default-icon.png" alt="<%= guild.name %> Icon" class="rounded-circle mb-3"><% } %>
            </a>
            <h4 class="mt-2 mb-1"><%= guild.name %></h4>
            <a href="/dashboard" class="btn btn-sm btn-secondary mt-2">Change Server</a>
        </div>
        <div class="sidebar-card">
            <h5><i class="fas fa-signal me-2"></i>Live Status</h5>
            <div id="live-status-container" class="live-status-scroll mb-2"><p class="text-center small">Loading...</p></div>
            <div id="live-status-pagination" class="d-flex justify-content-between align-items-center" style="display: none !important;">
                <button id="live-prev-btn" class="btn btn-sm btn-secondary"><i class="fas fa-arrow-left"></i></button>
                <span id="live-page-info" class="small text-muted"></span>
                <button id="live-next-btn" class="btn btn-sm btn-secondary"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        <div class="sidebar-card flex-grow-1">
            <h5><i class="fas fa-toolbox me-2"></i>Toolbox</h5>
            <ul class="nav nav-pills flex-column" id="toolbox-tabs" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link w-100 mb-1 active" data-bs-toggle="tab" data-bs-target="#streamers-tab">Streamer List</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link w-100 mb-1" data-bs-toggle="tab" data-bs-target="#core-tab">Core Settings</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link w-100 mb-1" data-bs-toggle="tab" data-bs-target="#appearance-tab">Appearance</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link w-100 mb-1" data-bs-toggle="tab" data-bs-target="#teams-tab">Twitch Teams</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#csv-tab">Mass Management</button></li>
            </ul>
        </div>
    </aside>
    <main class="manage-main-content">
        <div class="tab-content">
            <div class="tab-pane fade" id="core-tab" role="tabpanel"><%- include('partials/manage/core', {guild, settings, channels, roles}) %></div>
            <div class="tab-pane fade" id="appearance-tab" role="tabpanel"><%- include('partials/manage/appearance', {guild, channels, channelSettings}) %></div>
            <div class="tab-pane fade" id="teams-tab" role="tabpanel"><%- include('partials/manage/teams', {guild, channels, teamSubscriptions, roles}) %></div>
            <div class="tab-pane fade" id="csv-tab" role="tabpanel"><%- include('partials/manage/mass', {guild, channels}) %></div>
            <div class="tab-pane fade show active" id="streamers-tab" role="tabpanel">
                <div class="content-card">
                    <h2><i class="fas fa-user-plus me-2"></i>Add Streamer</h2>
                    <form action="/manage/<%= guild.id %>/add" method="POST">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3"><label class="form-label">Platform</label><select name="platform" class="form-select"><option value="twitch">Twitch</option><option value="kick">Kick</option><option value="youtube">YouTube</option></select></div>
                            <div class="col-md-4"><label class="form-label">Username/ID</label><input type="text" name="username" class="form-control" required></div>
                            <div class="col-md-5"><label class="form-label">Link Discord User</label><input type="text" name="discord_user_id" class="form-control" placeholder="Optional User ID"></div>
                        </div>
                        <div class="row g-3 mt-1 align-items-end">
                            <div class="col"><label class="form-label">Announce In Channels</label><select name="announcement_channel_id" class="form-select" multiple size="3"><option value="">-- Use Server Default --</option><% channels.forEach(channel => { %><option value="<%= channel.id %>">#<%= channel.name %></option><% }) %></select></div>
                            <div class="col-auto"><button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Streamer</button></div>
                        </div>
                    </form>
                </div>
                <div class="content-card">
                    <h2><i class="fas fa-stream me-2"></i>Tracked Streamers (<%= consolidatedStreamers.length %>)</h2>
                    <div class="accordion" id="streamersAccordion">
                        <% if (consolidatedStreamers.length > 0) { %>
                            <% consolidatedStreamers.forEach((streamer, index) => { %>
                                <div class="accordion-item mb-2">
                                    <h2 class="accordion-header" id="heading-<%= streamer.id %>">
                                        <button class="accordion-button <%= index > 0 ? 'collapsed' : '' %>" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= streamer.id %>" aria-expanded="<%= index === 0 ? 'true' : 'false' %>" aria-controls="collapse-<%= streamer.id %>">
                                            <img src="<%= streamer.primaryAvatar %>" alt="<%= streamer.primaryUsername %> Avatar" class="rounded-circle me-2" width="24" height="24">
                                            <strong><%= streamer.primaryUsername %></strong>
                                            <span class="badge bg-primary ms-2"><%= streamer.platforms.length %> Platforms</span>
                                            <span class="badge bg-secondary ms-2"><%= streamer.subscriptions.length %> Subscriptions</span>
                                        </button>
                                    </h2>
                                    <div id="collapse-<%= streamer.id %>" class="accordion-collapse collapse <%= index === 0 ? 'show' : '' %>" aria-labelledby="heading-<%= streamer.id %>" data-bs-parent="#streamersAccordion">
                                        <div class="accordion-body">
                                            <h6>Platforms:</h6>
                                            <ul class="list-group list-group-flush mb-3">
                                                <% streamer.platforms.forEach(platform => { %>
                                                    <li class="list-group-item d-flex align-items-center px-0 py-1">
                                                        <% if (platform.platform === 'twitch') { %><i class="fab fa-twitch platform-icon-fa platform-icon-twitch me-2"></i><% } else if (platform.platform === 'youtube') { %><i class="fab fa-youtube platform-icon-fa platform-icon-youtube me-2"></i><% } else if (platform.platform === 'kick') { %><i class="fas fa-k platform-icon-fa platform-icon-kick me-2"></i><% } else if (platform.platform === 'tiktok') { %><i class="fab fa-tiktok platform-icon-fa platform-icon-tiktok me-2"></i><% } else if (platform.platform === 'trovo') { %><i class="fas fa-t platform-icon-fa platform-icon-trovo me-2"></i><% } %>
                                                        <%= platform.username %> (<%= platform.platform %>)
                                                        <% if (platform.discord_user_id) { %><span class="badge bg-info ms-2">Linked to Discord</span><% } %>
                                                    </li>
                                                <% }); %>
                                            </ul>

                                            <h6>Subscriptions:</h6>
                                            <% if (streamer.subscriptionsByChannel.length > 0) { %>
                                                <% streamer.subscriptionsByChannel.forEach(channelGroup => { %>
                                                    <div class="mb-3">
                                                        <strong>Channel: <%= channelGroup.channelName %></strong>
                                                        <ul class="list-group list-group-flush">
                                                            <% channelGroup.subs.forEach(sub => { %>
                                                                <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                                                                    <div>
                                                                        <% if (sub.platform === 'twitch') { %><i class="fab fa-twitch platform-icon-fa platform-icon-twitch me-2"></i><% } else if (sub.platform === 'youtube') { %><i class="fab fa-youtube platform-icon-fa platform-icon-youtube me-2"></i><% } else if (sub.platform === 'kick') { %><i class="fas fa-k platform-icon-fa platform-icon-kick me-2"></i><% } else if (sub.platform === 'tiktok') { %><i class="fab fa-tiktok platform-icon-fa platform-icon-tiktok me-2"></i><% } else if (sub.platform === 'trovo') { %><i class="fas fa-t platform-icon-fa platform-icon-trovo me-2"></i><% } %>
                                                                        <%= sub.platform.charAt(0).toUpperCase() + sub.platform.slice(1) %>
                                                                        <% if (sub.override_nickname) { %><span class="badge bg-info ms-2">Nickname: <%= sub.override_nickname %></span><% } %>
                                                                        <% if (sub.custom_message) { %><span class="badge bg-info ms-2">Custom Message</span><% } %>
                                                                    </div>
                                                                    <div>
                                                                        <a href="#" role="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#streamerSettingsModal"
                                                                           data-consolidated-streamer-id="<%= streamer.id %>"
                                                                           data-streamer-name="<%= streamer.primaryUsername %>"
                                                                           data-discord-user-id="<%= streamer.discordUserId || '' %>"
                                                                           data-platforms='<%= JSON.stringify(streamer.platforms) %>'
                                                                           data-subscriptions='<%= JSON.stringify(streamer.subscriptions) %>'
                                                                        >
                                                                            <i class="fas fa-cog"></i>
                                                                        </a>
                                                                        <form action="/manage/<%= guild.id %>/remove-subscription" method="POST" class="d-inline" onsubmit="return confirm('Remove this subscription for <%= streamer.primaryUsername %> on <%= sub.platform %> in <%= channelGroup.channelName %>?')">
                                                                            <input type="hidden" name="subscription_id" value="<%= sub.subscription_id %>">
                                                                            <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-times"></i></button>
                                                                        </form>
                                                                    </div>
                                                                </li>
                                                            <% }); %>
                                                        </ul>
                                                    </div>
                                                <% }); %>
                                            <% } else { %>
                                                <p class="text-muted">No subscriptions found for this streamer.</p>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <p class="text-center p-3 mb-0">No streamers configured for this server.</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<%- include('partials/manage-modal', { guild, channels, userPreferences }) %>
<%- include('partials/footer') %>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const guildId = '<%= guild.id %>';
        const channels = <%- JSON.stringify(channels.map(c => ({id: c.id, name: c.name}))) %>;
        const liveStatusContainer = document.getElementById("live-status-container");
        const paginationContainer = document.getElementById("live-status-pagination");
        const prevBtn = document.getElementById("live-prev-btn");
        const nextBtn = document.getElementById("live-next-btn");
        const pageInfo = document.getElementById("live-page-info");

        let liveStreamersData = [];
        let currentPage = 1;
        const streamersPerPage = 5;

        function renderLivePage() {
            liveStatusContainer.innerHTML = "";
            paginationContainer.style.display = 'none';

            if (liveStreamersData.length === 0) {
                liveStatusContainer.innerHTML = '<p class="text-center small">No one is currently live.</p>';
                return;
            }

            paginationContainer.style.display = 'flex';
            const totalPages = Math.ceil(liveStreamersData.length / streamersPerPage);
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

            const start = (currentPage - 1) * streamersPerPage;
            const end = start + streamersPerPage;
            const paginatedStreamers = liveStreamersData.slice(start, end);

            paginatedStreamers.forEach(streamer => {
                const card = document.createElement("div");
                card.className = "live-streamer-card";
                const iconsHtml = streamer.live_platforms.map(p => {
                    if (p.platform === 'kick') return '<i class="fas fa-k platform-icon-fa platform-icon-kick"></i>';
                    if (p.platform === 'trovo') return '<i class="fas fa-t platform-icon-fa platform-icon-trovo"></i>';
                    return `<i class="fab fa-${p.platform} platform-icon-fa platform-icon-${p.platform}"></i>`;
                }).join(" ");
                const game = streamer.live_platforms && streamer.live_platforms.length > 0 ? streamer.live_platforms[0].game : "N/A";
                card.innerHTML = `<img src="${streamer.avatar_url || "/images/default-icon.png"}" class="live-avatar" alt="${streamer.username}"><div class="live-info"><strong>${streamer.username} <span class="platform-icons">${iconsHtml}</span></strong><span>${game || "N/A"}</span></div>`;
                liveStatusContainer.appendChild(card);
            });

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        async function fetchGuildLiveStatus() {
            if (!liveStatusContainer) return;
            try {
                const response = await fetch(`/api/guilds/${guildId}/livestatus`);
                const data = await response.json();
                if (!response.ok || data.error) {
                    throw new Error(data.message || "API request failed");
                }
                liveStreamersData = Array.isArray(data) ? data : [];
                const totalPages = Math.ceil(liveStreamersData.length / streamersPerPage);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                }
                renderLivePage();
            } catch (error) {
                console.error("Guild Live Status Error:", error);
                liveStatusContainer.innerHTML = '<p class="text-danger text-center small">Failed to load status.</p>';
                paginationContainer.style.display = 'none';
            }
        }

        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderLivePage();
            }
        });

        nextBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(liveStreamersData.length / streamersPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderLivePage();
            }
        });

        fetchGuildLiveStatus();
        setInterval(fetchGuildLiveStatus, 60000);

        const modal = document.getElementById("streamerSettingsModal");
        if (modal) {
            modal.addEventListener("show.bs.modal", function(event) {
                const button = event.relatedTarget;
                const platformsContainer = modal.querySelector("#modal-platforms-container");
                const subscriptionsContainer = modal.querySelector("#modal-subscriptions-container");
                platformsContainer.innerHTML = '';
                subscriptionsContainer.innerHTML = '';

                modal.querySelector("#modal-streamer-name").textContent = button.getAttribute("data-streamer-name");
                modal.querySelector("#edit-consolidated-streamer-id").value = button.getAttribute("data-consolidated-streamer-id");
                modal.querySelector("#edit-discord-user-id").value = button.getAttribute("data-discord-user-id");

                const platforms = JSON.parse(button.getAttribute("data-platforms"));
                const subscriptions = JSON.parse(button.getAttribute("data-subscriptions"));

                platforms.forEach(platform => {
                    const platformHtml = `
                        <div class="mb-2 p-2 border rounded bg-light">
                            <div class="d-flex align-items-center mb-2">
                                ${platform.platform === 'twitch' ? '<i class="fab fa-twitch platform-icon-fa platform-icon-twitch me-2"></i>' : ''}
                                ${platform.platform === 'youtube' ? '<i class="fab fa-youtube platform-icon-fa platform-icon-youtube me-2"></i>' : ''}
                                ${platform.platform === 'kick' ? '<i class="fas fa-k platform-icon-fa platform-icon-kick me-2"></i>' : ''}
                                ${platform.platform === 'tiktok' ? '<i class="fab fa-tiktok platform-icon-fa platform-icon-tiktok me-2"></i>' : ''}
                                ${platform.platform === 'trovo' ? '<i class="fas fa-t platform-icon-fa platform-icon-trovo me-2"></i>' : ''}
                                <strong>${platform.platform.charAt(0).toUpperCase() + platform.platform.slice(1)}: ${platform.username}</strong>
                            </div>
                            <input type="hidden" name="platforms[${platform.streamer_id}][streamer_id]" value="${platform.streamer_id}">
                            <input type="hidden" name="platforms[${platform.streamer_id}][platform]" value="${platform.platform}">
                            <input type="hidden" name="platforms[${platform.streamer_id}][username]" value="${platform.username}">
                            ${platform.platform === 'twitch' ? `
                                <div class="mb-1">
                                    <label class="form-label small">Linked Kick Username</label>
                                    <input type="text" class="form-control form-control-sm" name="platforms[${platform.streamer_id}][kick_username]" placeholder="Optional Kick Username" value="${platform.kick_username || ''}">
                                </div>
                            ` : ''}
                        </div>
                    `;
                    platformsContainer.insertAdjacentHTML('beforeend', platformHtml);
                });

                subscriptions.forEach(sub => {
                    const channelOptions = channels.map(channel =>
                        `<option value="${channel.id}" ${sub.announcement_channel_id === channel.id ? 'selected' : ''}>#${channel.name}</option>`
                    ).join('');
                    const channelName = sub.announcement_channel_id ? `#${channels.find(c => c.id === sub.announcement_channel_id)?.name || 'Unknown'}` : 'Server Default';

                    const subHtml = `
                        <div class="border p-3 mb-3 rounded bg-light">
                            <strong>Subscription for ${sub.platform.charAt(0).toUpperCase() + sub.platform.slice(1)} in ${channelName}</strong>
                            <input type="hidden" name="subscriptions[${sub.subscription_id}][subscription_id]" value="${sub.subscription_id}">
                            <input type="hidden" name="subscriptions[${sub.subscription_id}][streamer_id]" value="${sub.streamer_id}">
                            <div class="mb-2 mt-2">
                                <label class="form-label small">Announcement Channel</label>
                                <select class="form-select form-select-sm" name="subscriptions[${sub.subscription_id}][announcement_channel_id]">
                                    <option value="">-- Use Server Default --</option>
                                    ${channelOptions}
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Custom Webhook Nickname</label>
                                <input type="text" class="form-control form-control-sm" name="subscriptions[${sub.subscription_id}][override_nickname]" value="${sub.override_nickname || ''}" placeholder="Leave blank to use channel/server default">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Custom Announcement Message</label>
                                <textarea class="form-control form-control-sm" name="subscriptions[${sub.subscription_id}][custom_message]" rows="2" placeholder="e.g. {username} is live with {game}!">${sub.custom_message || ''}</textarea>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Override Avatar URL</label>
                                <input type="text" class="form-control form-control-sm" name="subscriptions[${sub.subscription_id}][override_avatar_url_text]" value="${sub.override_avatar_url || ''}" placeholder='URL or type "reset" to clear'>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="subscriptions[${sub.subscription_id}][reset_avatar]" id="reset-avatar-${sub.subscription_id}">
                                <label class="form-check-label" for="reset-avatar-${sub.subscription_id}">Reset Avatar</label>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Privacy Level</label>
                                <select class="form-select form-select-sm" name="subscriptions[${sub.subscription_id}][privacy_level]">
                                    <option value="" ${!sub.privacy_level ? 'selected' : ''}>-- Use Default --</option>
                                    <option value="public" ${sub.privacy_level === 'public' ? 'selected' : ''}>Public</option>
                                    <option value="members" ${sub.privacy_level === 'members' ? 'selected' : ''}>Members Only</option>
                                    <option value="subscribers" ${sub.privacy_level === 'subscribers' ? 'selected' : ''}>Subscribers Only</option>
                                </select>
                            </div>
                            ${sub.platform === 'youtube' ? `
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="subscriptions[${sub.subscription_id}][youtube_vod_notifications]" id="youtube-vods-${sub.subscription_id}" ${sub.youtube_vod_notifications ? 'checked' : ''}>
                                <label class="form-check-label" for="youtube-vods-${sub.subscription_id}">Post YouTube VODs</label>
                            </div>
                            ` : ''}
                            ${sub.platform === 'tiktok' ? `
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="subscriptions[${sub.subscription_id}][tiktok_vod_notifications]" id="tiktok-vods-${sub.subscription_id}" ${sub.tiktok_vod_notifications ? 'checked' : ''}>
                                <label class="form-check-label" for="tiktok-vods-${sub.subscription_id}">Post TikTok VODs</label>
                            </div>
                            ` : ''}
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="subscriptions[${sub.subscription_id}][keep_summary]" id="keep-summary-${sub.subscription_id}" ${!sub.delete_on_end ? 'checked' : ''}>
                                <label class="form-check-label" for="keep-summary-${sub.subscription_id}">Keep as summary when stream ends</label>
                            </div>
                        </div>
                    `;
                    subscriptionsContainer.insertAdjacentHTML('beforeend', subHtml);
                });
            });
        }
    });
</script>
</body>
</html>